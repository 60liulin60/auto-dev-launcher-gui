# 功能更新说明

## 版本 1.0.0 - 新增功能

### 1. 删除项目时自动停止服务器 ✅

**功能描述：**
- 当用户点击"删除"按钮删除项目时，系统会先检查该项目的服务器是否正在运行
- 如果服务器正在运行，会先自动停止服务器进程
- 等待 500ms 确保服务器完全停止后，再从历史记录中删除项目

**使用场景：**
- 避免删除项目后留下孤立的运行进程
- 防止端口被占用
- 确保资源被正确释放

---

### 2. 关闭程序时自动停止所有服务器 ✅

**功能描述：**
- 当用户关闭应用窗口时，会先阻止默认关闭行为
- 自动保存窗口尺寸和位置设置
- 停止所有正在运行的服务器进程
- 确保所有服务器都停止后，才真正关闭窗口

**使用场景：**
- 确保关闭程序时不会留下后台运行的开发服务器
- 避免端口被占用导致下次启动失败
- 保证系统资源被正确清理

---

### 3. 自动检测并安装依赖 ✅ **NEW!**

**功能描述：**
- 启动项目前，自动检查项目目录下是否存在 `node_modules` 文件夹
- 如果 `node_modules` 不存在，会自动检测项目使用的包管理器：
  - 检测到 `pnpm-lock.yaml` → 使用 `pnpm install`
  - 检测到 `yarn.lock` → 使用 `yarn install`
  - 检测到 `package-lock.json` → 使用 `npm install`
  - 默认使用 `npm install`
- 在服务器输出窗口实时显示依赖安装进度
- 依赖安装完成后，自动启动项目

**使用场景：**
- 首次克隆项目后，无需手动安装依赖
- 删除 `node_modules` 后重新启动，自动重新安装
- 避免因缺少依赖导致的启动失败

**输出示例：**
```
检测到缺少 node_modules 目录，正在使用 pnpm 安装依赖...
执行命令: pnpm install

Packages: +399
++++++++++++++++++++++++++++++++++++++++++++
Progress: resolved 399, reused 399, downloaded 0, added 399, done

✓ 依赖安装完成，开始启动项目...

> prototype-vue-preview@1.0.0 dev
> vite

  VITE v5.0.0  ready in 500 ms
  ➜  Local:   http://localhost:5173/
```

---

## 技术实现

### 依赖安装逻辑
```typescript
// 1. 检测包管理器
private detectPackageManager(projectPath: string): string {
  if (fs.existsSync(path.join(projectPath, 'pnpm-lock.yaml'))) {
    return 'pnpm'
  } else if (fs.existsSync(path.join(projectPath, 'yarn.lock'))) {
    return 'yarn'
  } else if (fs.existsSync(path.join(projectPath, 'package-lock.json'))) {
    return 'npm'
  }
  return 'npm'
}

// 2. 检查并安装依赖
private async installDependenciesIfNeeded(projectId: string, projectPath: string) {
  const nodeModulesPath = path.join(projectPath, 'node_modules')
  
  // 如果 node_modules 不存在，则安装依赖
  if (!fs.existsSync(nodeModulesPath)) {
    const packageManager = this.detectPackageManager(projectPath)
    // 执行安装并实时输出进度
    await this.runInstall(packageManager, projectPath, projectId)
  }
}
```

---

## 测试建议

1. **测试删除功能：**
   - 启动一个项目
   - 在项目运行时点击"删除"按钮
   - 确认服务器被正确停止，项目从列表中移除

2. **测试关闭程序：**
   - 启动多个项目
   - 关闭应用窗口
   - 检查任务管理器，确认没有遗留的 node 进程

3. **测试自动安装依赖：**
   - 选择一个没有 `node_modules` 的项目
   - 点击"启动"按钮
   - 观察输出窗口，确认依赖自动安装
   - 等待安装完成后，项目自动启动

---

## 注意事项

- 依赖安装可能需要较长时间，请耐心等待
- 安装过程中会在输出窗口显示实时进度
- 如果安装失败，会显示错误信息
- 建议在网络良好的环境下使用自动安装功能
