# 实现计划：自动开发服务器启动工具

## 概述

本实现计划将设计文档转化为一系列可执行的编码任务。每个任务都是增量式的，建立在前面任务的基础上，确保代码逐步集成，没有孤立或未连接的代码。

## 任务列表

- [x] 1. 项目初始化和基础设施搭建
  - 创建 TypeScript 项目结构
  - 配置 tsconfig.json、package.json
  - 安装核心依赖：chalk（日志颜色）、inquirer（用户交互）
  - 安装开发依赖：typescript、@types/node、jest、@types/jest、fast-check
  - 配置 Jest 测试框架
  - 创建基本的目录结构：src/、tests/、templates/
  - _需求：9.1, 9.2_

- [x] 2. 实现日志管理器模块
  - [x] 2.1 创建 Logger 类和接口定义
    - 定义 LogLevel 类型和 LogOptions 接口
    - 实现 info、success、warning、error 方法
    - 使用 chalk 库实现彩色输出
    - 实现 startProject 和 showSummary 方法
    - _需求：8.1, 8.2, 8.8_
  
  - [x] 2.2 编写 Logger 单元测试
    - 测试不同日志级别的输出
    - 测试颜色代码是否正确应用
    - 测试摘要信息格式
    - _需求：8.1, 8.2, 8.8_

- [x] 3. 实现配置管理器模块
  - [x] 3.1 创建配置数据模型和接口
    - 定义 ProjectConfig 接口
    - 定义 Config 接口
    - 定义 ValidationResult 接口
    - _需求：1.1, 11.1, 11.2, 11.3, 11.4, 11.5, 11.6_
  
  - [x] 3.2 实现 ConfigManager 类
    - 实现 readConfig 方法（读取 JSON 文件）
    - 实现 createDefaultConfig 方法（创建模板）
    - 实现 validateConfig 方法（验证配置格式）
    - 实现 getConfigPath 方法（支持命令行参数）
    - 处理文件不存在、格式错误等异常情况
    - _需求：1.1, 1.2, 1.3, 1.4, 1.5_
  
  - [x] 3.3 编写配置管理器单元测试
    - 测试配置文件不存在时创建默认模板
    - 测试格式错误的配置文件处理
    - 测试各种配置选项的解析
    - _需求：1.2, 1.3_
  
  - [x] 3.4 编写属性测试：配置文件读取的一致性
    - **属性 1：配置文件读取的一致性**
    - **验证需求：1.1, 1.4, 1.5**
    - 生成随机配置对象，写入文件后读取，验证值的一致性
  
  - [x] 3.5 编写属性测试：配置文件格式验证
    - **属性 2：配置文件格式验证**
    - **验证需求：1.3**
    - 生成各种格式错误的配置，验证系统正确拒绝
  
  - [x] 3.6 编写属性测试：配置扩展字段的解析正确性
    - **属性 17：配置扩展字段的解析正确性**
    - **验证需求：11.1, 11.2, 11.3, 11.4, 11.5, 11.6**
    - 生成包含各种扩展字段的配置，验证解析和默认值处理

- [x] 4. 实现项目验证器模块
  - [x] 4.1 创建 ProjectValidator 类
    - 实现 validatePath 方法（检查路径是否存在）
    - 实现 hasPackageJson 方法（检查 package.json）
    - 实现 normalizePath 方法（相对路径转绝对路径）
    - 实现 validate 方法（完整验证）
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [x] 4.2 编写属性测试：路径规范化的往返一致性
    - **属性 3：路径规范化的往返一致性**
    - **验证需求：2.5**
    - 生成随机相对路径，验证转换后指向同一位置
  
  - [x] 4.3 编写属性测试：路径验证的正确性
    - **属性 4：路径验证的正确性**
    - **验证需求：2.1, 2.2, 2.3, 2.4**
    - 生成存在和不存在的路径，验证验证逻辑
  
  - [x] 4.4 编写属性测试：特殊字符路径处理的鲁棒性
    - **属性 18：特殊字符路径处理的鲁棒性**
    - **验证需求：12.6, 12.7**
    - 生成包含特殊字符的路径，验证处理正确性

- [x] 5. 实现依赖检测器模块
  - [x] 5.1 创建 DependencyDetector 类
    - 定义 DependencyStatus 接口
    - 实现 detect 方法（检测依赖状态）
    - 实现 checkNodeModules 方法（检查目录存在）
    - 实现 isNodeModulesEmpty 方法（检查是否为空）
    - _需求：3.1, 3.2, 3.3, 3.4, 3.5_
  
  - [x] 5.2 编写属性测试：依赖状态检测的准确性
    - **属性 5：依赖状态检测的准确性**
    - **验证需求：3.1, 3.2, 3.3, 3.4**
    - 生成不同状态的 node_modules，验证检测准确性
    - 包含边缘情况：空目录的处理

- [x] 6. 实现包管理器识别器模块
  - [x] 6.1 创建 PackageManagerDetector 类
    - 定义 PackageManager 类型和 LockFileMapping 接口
    - 实现 detect 方法（识别包管理器）
    - 实现 hasLockFile 方法（检查锁文件）
    - 实现 getInstallCommand 方法（获取安装命令）
    - 实现 getRunCommand 方法（获取运行命令）
    - 按优先级检查：pnpm-lock.yaml > yarn.lock > bun.lockb > package-lock.json > 默认 npm
    - _需求：4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_
  
  - [x] 6.2 编写单元测试：特定锁文件识别
    - 测试 pnpm-lock.yaml → pnpm
    - 测试 yarn.lock → yarn
    - 测试 bun.lockb → bun
    - 测试 package-lock.json → npm
    - 测试无锁文件 → npm（默认）
    - _需求：4.2, 4.3, 4.4, 4.5, 4.6_
  
  - [x] 6.3 编写属性测试：包管理器识别的映射正确性
    - **属性 6：包管理器识别的映射正确性**
    - **验证需求：4.1, 4.2, 4.3, 4.4, 4.5, 4.6**
    - 生成不同锁文件组合，验证识别逻辑
  
  - [x] 6.4 编写属性测试：包管理器命令映射的正确性
    - **属性 7：包管理器命令映射的正确性**
    - **验证需求：5.1, 5.2, 5.3, 5.4, 5.5**
    - 验证每种包管理器的安装和运行命令格式

- [x] 7. 实现依赖安装器模块
  - [x] 7.1 创建 DependencyInstaller 类
    - 定义 InstallResult 接口
    - 实现 install 方法（安装依赖）
    - 实现 executeInstall 方法（执行命令）
    - 实现 showProgress 方法（显示进度）
    - 使用 child_process 执行安装命令
    - 捕获和处理安装错误
    - _需求：5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8_
  
  - [x] 7.2 编写属性测试：依赖安装流程的容错性
    - **属性 8：依赖安装流程的容错性**
    - **验证需求：5.6, 5.7, 12.3**
    - 模拟安装成功和失败场景，验证流程继续

- [x] 8. 实现启动命令选择器模块
  - [x] 8.1 创建 StartCommandSelector 类
    - 定义 PackageJson 接口
    - 实现 readPackageJson 方法（读取 package.json）
    - 实现 selectCommand 方法（选择启动命令）
    - 实现 hasScript 方法（检查脚本存在）
    - 实现 getFirstAvailableScript 方法（按优先级选择）
    - 优先级：自定义命令 > dev > start > serve
    - _需求：6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_
  
  - [x] 8.2 编写属性测试：启动命令选择的优先级正确性
    - **属性 9：启动命令选择的优先级正确性**
    - **验证需求：6.2, 6.3, 6.4, 6.5, 6.6**
    - 生成不同 scripts 组合，验证选择逻辑
  
  - [x] 8.3 编写属性测试：启动命令与包管理器的组合正确性
    - **属性 10：启动命令与包管理器的组合正确性**
    - **验证需求：6.7**
    - 验证命令格式符合包管理器规范

- [x] 9. 实现项目启动器模块
  - [x] 9.1 创建 ProjectLauncher 类
    - 定义 LaunchOptions 和 LaunchResult 接口
    - 实现 launch 方法（启动项目）
    - 实现 launchInNewWindow 方法（新窗口启动）
    - 实现 setWindowTitle 方法（设置标题）
    - 实现 buildCommand 方法（构建命令）
    - 使用 child_process.spawn 在新窗口启动
    - Windows 使用 cmd.exe /k 保持窗口打开
    - _需求：7.1, 7.2, 7.3, 7.4, 7.5, 7.6_
  
  - [x] 9.2 编写属性测试：项目启动顺序的保持性
    - **属性 11：项目启动顺序的保持性**
    - **验证需求：7.5**
    - 验证启动顺序与配置顺序一致
  
  - [x] 9.3 编写属性测试：窗口配置的完整性
    - **属性 12：窗口配置的完整性**
    - **验证需求：7.2, 7.3**
    - 验证窗口标题和显示内容
  
  - [x] 9.4 编写属性测试：启动延迟的一致性
    - **属性 13：启动延迟的一致性**
    - **验证需求：7.4**
    - 验证启动间隔时间

- [x] 10. 实现主程序入口
  - [x] 10.1 创建 AutoDevLauncher 主类
    - 注入所有依赖模块
    - 实现 run 方法（主执行流程）
    - 实现 processProject 方法（处理单个项目）
    - 实现 confirmInstallation 方法（用户确认）
    - 实现 showWelcome 方法（欢迎信息）
    - 实现 waitForExit 方法（等待退出）
    - 协调各模块完成完整流程
    - _需求：1.1, 2.1, 3.1, 4.1, 5.1, 6.1, 7.1, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_
  
  - [x] 10.2 创建 index.ts 入口文件
    - 实例化所有模块
    - 创建 AutoDevLauncher 实例
    - 调用 run 方法
    - 处理顶层异常
    - _需求：所有需求_
  
  - [x] 10.3 编写属性测试：用户确认流程的正确性
    - **属性 16：用户确认流程的正确性**
    - **验证需求：10.3, 10.4, 10.5**
    - 模拟用户确认和取消，验证流程
  
  - [x] 10.4 编写属性测试：日志完整性
    - **属性 14：日志完整性**
    - **验证需求：3.5, 4.7, 8.2, 8.3, 8.4, 8.5, 8.6**
    - 验证日志包含所有必要信息
  
  - [x] 10.5 编写属性测试：统计信息的准确性
    - **属性 15：统计信息的准确性**
    - **验证需求：8.8**
    - 验证成功和失败数量统计正确

- [x] 11. 创建配置文件模板
  - 在 templates/ 目录创建 dev-config.template.json
  - 包含示例项目配置
  - 包含所有可选字段的说明注释
  - _需求：1.2, 9.3_

- [x] 12. 检查点 - 确保所有测试通过
  - 运行所有单元测试：`npm test`
  - 运行所有属性测试：`npm run test:property`
  - 确保代码覆盖率 ≥ 85%
  - 修复任何失败的测试
  - 如有问题，询问用户

- [x] 13. 配置打包工具
  - [x] 13.1 配置 pkg 打包
    - 在 package.json 中添加 pkg 配置
    - 指定目标平台：node18-win-x64
    - 配置资源文件打包（templates/）
    - 配置输出路径：build/
    - _需求：9.1, 9.2, 9.3, 9.4_
  
  - [x] 13.2 添加构建脚本
    - 添加 build 脚本：编译 TypeScript
    - 添加 package 脚本：打包成 exe
    - 添加 clean 脚本：清理构建产物
    - _需求：9.1_
  
  - [x] 13.3 测试打包流程
    - 执行 `npm run build`
    - 执行 `npm run package`
    - 验证生成的 exe 文件
    - 测试 exe 文件在无 Node.js 环境下运行
    - 验证文件大小 < 50MB
    - _需求：9.1, 9.2, 9.6_

- [x] 14. 编写文档
  - [x] 14.1 更新 README.md
    - 添加项目简介
    - 添加功能特性列表
    - 添加使用说明
    - 添加配置文件格式说明
    - 添加常见问题解答
    - 添加开发指南
  
  - [x] 14.2 创建 CHANGELOG.md
    - 记录版本 1.0.0 的功能
    - 记录已知问题和限制
  
  - [x] 14.3 添加代码注释
    - 为所有公共接口添加 JSDoc 注释
    - 为复杂逻辑添加行内注释
    - 确保代码可读性

- [x] 15. 最终检查点 - 完整测试
  - 运行完整测试套件
  - 测试各种配置场景
  - 测试错误处理
  - 测试打包后的 exe 文件
  - 验证所有需求都已实现
  - 如有问题，询问用户

- [x] 16. 集成测试
  - [x] 16.1 创建端到端测试
    - 创建测试项目目录
    - 测试完整的启动流程
    - 测试依赖安装流程
    - 测试错误场景
    - _需求：所有需求_

## 注意事项

- 每个任务都引用了具体的需求编号，便于追溯
- 检查点任务确保增量验证
- 属性测试任务明确标注了属性编号和验证的需求
- 所有代码应该是增量式的，每个任务都建立在前面任务的基础上

## 实现顺序说明

1. **基础设施**（任务 1-2）：搭建项目结构和日志系统
2. **核心模块**（任务 3-9）：按依赖顺序实现各个模块
3. **主程序**（任务 10）：集成所有模块
4. **打包部署**（任务 11-13）：配置打包和测试
5. **文档完善**（任务 14）：编写用户和开发文档
6. **最终验证**（任务 15-16）：完整测试和验证
